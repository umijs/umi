import { Message } from 'umi';

# Internationalization

`@umi/max` comes with a built-in [Internationalization (i18n) plugin](https://github.com/umijs/umi/blob/master/packages/plugins/src/locale.ts) that makes it easy to integrate internationalization features into your Umi application.

## Getting Started

The internationalization plugin uses a conventional directory structure. We agree to import language files under the `src/locales` directory.

Language files should be named according to this convention: `<lang><separator><COUNTRY>.(js|json|ts)`. Here, `<separator>` is a separator character, which is `-` by default but can be configured using the `baseSeparator` option.

For example, if you need to introduce language support for Simplified Chinese and English in your project, you can create two files, `zh-CN.ts` and `en-US.ts`, under the `src/locales` directory:

```diff
src
  + locales
    + zh-CN.ts
    + en-US.ts
  pages
```

Configure the internationalization plugin in `.umirc.ts`:

```ts
export default {
  locale: {
    // Use src/locales/zh-CN.ts as the default language file
    default: 'zh-CN',
    baseSeparator: '-',
  },
};
```

For more detailed configuration, see the [Configuration Plugin](#configuration-plugin) section.

Now, add your first piece of localized content:

```ts
// src/locales/zh-CN.ts
export default {
  welcome: '欢迎光临 Umi 的世界！',
};
```

```ts
// src/locales/en-US.ts
export default {
  welcome: "Welcome to Umi's world!",
};
```

You can also use `.json` files to store language content:

```json
// src/locales/zh-CN.json
{
  "welcome": "欢迎光临 Umi 的世界！"
}

// src/locales/en-US.json
{
  "welcome": "Welcome to Umi's world!"
}
```

Everything is set up, and now you can use localized content in Umi. Let's give it to our `<FormattedMessage />` component. Just pass the previously defined `welcome` as the value for the `id` parameter:

```tsx
import { FormattedMessage } from 'umi';

export default function Page() {
  return (
    <div>
      <FormattedMessage id="welcome" />
    </div>
  );
};
```

The rendered result will be:

```html
<!-- zh-CN -->
<div>欢迎光临 Umi 的世界！</div>

<!-- en-US -->
<div>Welcome to Umi's world!</div>
```

## Using in Component Parameters

In some cases, you might need to pass localized content as parameters to a component. You can achieve this using the `intl` object:

```tsx
import { Alert } from 'antd';
import { useIntl } from 'umi';

export default function Page() {
  const intl = useIntl();
  const msg = intl.formatMessage({
    id: 'welcome',
  });

  return <Alert message={msg} type="success" />;
};
```

At its core, the internationalization plugin is based on [`react-intl`](https://github.com/formatjs/formatjs/tree/main/packages/react-intl) and supports all its interfaces. For more details, see the [documentation](https://github.com/formatjs/formatjs/blob/main/website/docs/react-intl/api.md).

In the above code, we used the `useIntl()` interface provided by `react-intl` to initialize the `intl` object and called its [`formatMessage()`](https://github.com/formatjs/formatjs/blob/main/website/docs/react-intl/api.md#formatmessage) method to format the string.

## Formatting Strings

You might want to dynamically interpolate values in your localized translations. You can achieve this by writing your language content like this:

```ts
// src/locales/zh-CN.ts
export default {
  user: {
    welcome: '{name}，今天也是美好的一天！',
  },
};
```

```ts
// src/locales/en-US.ts
export default {
  user: {
    welcome: '{name}, what a nice day!',
  },
};
```

In the examples above, we used the special syntax `{name}` which allows us to dynamically assign values at runtime:

```tsx
import { FormattedMessage } from 'umi';

export default function Page() {
  return (
    <p>
      <FormattedMessage id="user.welcome" values={{ name: '张三' }} />
    </p>
  );
};
```

If you prefer to use the `intl` object, you can assign it like this:

```tsx
import { useIntl } from 'umi';

export default function Page() {
  const intl = useIntl();
  const msg = intl.formatMessage(
    {
      id: 'user.welcome',
    },
    {
      name: '张三',
    },
  );

  return <p>{msg}</p>;
};
```

Note that the key-value object used for assignment should be passed as the second argument to the `formatMessage()` method.

The rendered result will be:

```html
<!-- zh-CN -->
<p>张三，今天也是美好的一天！</p>

<!-- en-US -->
<p>张三, what a nice day!</p>
```

## Switching Languages

You can quickly add language switching functionality to your project using the preset `<SelectLang />` component. Just add it like this:

```tsx
import { SelectLang } from 'umi';

export default function Page() {
  return <SelectLang />;
};
```

In most cases, you might need to create your own language switching component. This is where the `setLocale()` interface shines:

```ts
import { setLocale } from 'umi';

// Reload the page when switching
setLocale('en-US');
```

When using this method to switch languages, the default behavior is to refresh the current page. You can set its second parameter to `false` to achieve language switching without refreshing:

```ts
// Switch without refreshing
setLocale('en-US', false);
```

If you need to switch back to the default language, just call this method without passing any parameters:

```ts
// If your default language is zh-CN
// The following call has the same effect as setLocale('zh-CN')
setLocale();
```

## Default Language Values

For consistency across pages, when Umi can't find the content corresponding to the `id` in the current language file, it directly renders the `id` as content on the page.

For example, if you write the following language files:

```ts
// src/locales/zh-CN.ts
export default {
  table: {
    submit: '提交表单',
  },
};
```

```ts
// src/locales/en-US.ts
export default {
  // table: {
  //   submit: 'SUBMIT TABLE',
  // },
};
```

And you have the following component:

```tsx
import { Button } from 'antd';
import { FormattedMessage } from 'umi';

export default function Page() {
  return (
    <Button type="primary">
      <FormattedMessage id="table.submit" />
    </Button>
  );
};
```

The rendered result will be:

```html
<!-- zh-CN -->
<button type="primary">提交表单</button>

<!-- en-US -->
<button type="primary">table.submit</button>
```

In particular, if you need to provide a default value before completing internationalization adaptation, you can use the `defaultMessage` parameter:

```tsx
import { Button } from 'antd';
import { FormattedMessage } from 'umi';

export default function Page() {
  return (
    <Button type="primary">
      <FormattedMessage id="table.submit" defaultMessage="SUBMIT TABLE" />
    </Button>
  );
};
```

You can also achieve this using the `formatMessage()` method:

```tsx
import { Button } from 'antd';
import { useIntl } from 'umi';

export default function Page() {
  const intl = useIntl();
  const msg = intl.formatMessage({
    id: 'table.submit',
    defaultMessage: 'SUBMIT TABLE',
  });

  return <Button type="primary">{msg}</Button>;
};
```

It's not recommended to use the `defaultMessage` configuration for default values, as this would involve writing a lot of repeated internationalization content. The best approach is to ensure that each language file contains all the keys used when you perform internationalization adaptation.

## Common Interface Introduction

### `addLocale` Dynamically Adding Language Support

You can dynamically add language support at runtime using the `addLocale()` interface. It takes three parameters:

| Parameter | Type     | Description                     |
| ----------| -------- | --------------------------------|
| `name`    | `String` | The key for the language        |
| `message` | `Object` | The object containing messages   |
| `options` | `Object` | `momentLocale` and `antd` configuration |

For example, if you want to dynamically add language support for Traditional Chinese, you can write the code as follows:

```ts
import { addLocale } from 'umi';
import zhTW from 'antd/es/locale/zh_TW';

addLocale(
  'zh-TW',
  {
    welcome: '歡迎光臨 Umi 的世界！',
  },
  {
    momentLocale: 'zh-tw',
    antd: zhTW,
  },
);
```

### `getAllLocales` Getting the List of Languages

You can use the `getAllLocales()` interface to get an array of all currently available language options, including those added using the `addLocale()` method. This interface defaults to looking for files with names like `zh-CN.(js|json|ts)` in the `src/locales` directory and returns the language keys.

```ts
import { getAllLocales } from 'umi';

getAllLocales();
// [en-US, zh-CN, ...]
```

### `getLocale` Getting the Current Language

You can use the `getLocale()` interface to get the currently selected language:

```ts
import { getLocale } from 'umi';

getLocale();
// zh-CN
```

### `useIntl` Getting the `intl` Object

`useIntl()` is likely to be the most commonly used interface during development. You can use it to get the `intl` object, and then further execute methods like `formatMessage()` to achieve your diverse requirements:

```json
// src/locales/en-US.json
{
  "welcome": "Hi, {name}."
}
```

```ts
import { useIntl } from 'umi';

const intl = useIntl();
const msg = intl.formatMessage(
  {
    id: 'welcome',
  },
  {
    name: 'Jackson',
  },
);
console.log(msg);
// Hi, Jackson.
```

For more usages of the `intl` object, refer to the [`react-intl` API documentation](https://github.com/formatjs/formatjs/blob/main/website/docs/react-intl/api.md).

### `setLocale` Setting the Language

You can use the `setLocale()` interface to dynamically set the current language programmatically. It has two parameters:

| Parameter     | Type      | Description                          |
| --------------| --------- | ------------------------------------ |
| `lang`        | `String`  | The language to switch to            |
| `realReload`  | `Boolean` | Whether to reload the page on switch |

```ts
import { setLocale } from 'umi';

// Reload the page when switching
setLocale('en-US');

// Switch without refreshing
setLocale('en-US', false);
```

## Configuration Plugin

You can configure the internationalization plugin in `.umirc.ts`. The default values are as follows:

```ts
export default {
  locale: {
    antd: false, // Set to true if your project has an `antd` dependency
    baseNavigator: true,
    baseSeparator: '-',
    default: 'zh-CN',
    title: false,
    useLocalStorage: true,
  },
};
```

Here's a detailed breakdown of the configuration options:

| Option           | Type      | Default Value               | Description |
| ---------------- | --------- | ----------------------------| ----------- |
| `antd`           | `Boolean` | `false` (true if `antd` is a project dependency) | Internationalization support for `antd`. For more information, see [this documentation](https://ant.design/docs/react/i18n). |
| `baseNavigator`  | `Boolean` | `true`                      | Enable **browser language detection**. By default, the current language is recognized in the following order: `localStorage`'s `umi_locale` value > browser detection > `default` setting's default language > `zh-CN`. |
| `baseSeparator`  | `String`  | `-`                         | Separator character between language (Language) and country (Country). The default is `-`, resulting in language codes like `zh-CN`, `en-US`, and `sk`. If set to `_`, the `default` should be set to `zh_CN`. |
| `default`        | `String`  | `zh-CN`                     | Default language of the project. Used when a specific language cannot be detected. |
| `title`          | `Boolean` | `false`                     | Enable [**Title Internationalization**](#title-internationalization). |
| `useLocalStorage`| `Boolean` | `true`                      | Automatically use `localStorage` to store the current language. |

### Title Internationalization

To enable internationalization support for titles, add the `title` field to your route configuration. This will automatically convert the page title to the corresponding localized content.

For example, consider the following language files:

```ts
// src/locales/zh-CN.ts
export default {
  'site.title': 'Umi - 企业级 React 应用开发框架',
  'about.title': 'Umi - 关于我',
};
```

```ts
// src/locales/en-US.ts
export default {
  'site.title': 'Umi - Enterprise-level React Application Framework',
  'about.title': 'Umi - About me',
};
```

Configure your routes like this:

```ts
// .umirc.ts
export default {
  title: 'site.title',
  routes: [
    {
      path: '/',
      component: 'Index',
    },
    {
      path: '/about',
      component: 'About',
      title: 'about.title',
    },
  ],
};
```

When you visit the pages:

- `/` route: When the language is `zh-CN`, the page title will be `Umi - 企业级 React 应用开发框架`. When the language is `en-US`, the title will be `Umi - Enterprise-level React Application Framework`.
- `/about` route: When the language is `zh-CN`, the title will be `Umi - 关于我`. When the language is `en-US`, the title will be `Umi - About me`.

## Runtime Extensions

The internationalization plugin allows you to extend and customize it at runtime.

### Custom `getLocale`

You can customize how the page language is obtained using the `getLocale()` method. For example, you might want to use a link like `?locale=en-US` to determine the language for the current page:

```ts
// src/app.ts
import qs from 'qs';

export const locale = {
  getLocale() {
    const { search } = window.location;
    const { locale = 'zh-CN' } = qs.parse(search, { ignoreQueryPrefix: true });
    return locale;
  },
};
```

### Custom Option Configuration
Umi's i18n is based on `react-intl`.
You need to configure more `react-intl` initialization options, you can do so in `app.ts`. You can refer to the [react-intl documentation](https://formatjs.io/docs/react-intl/components) for the specific configuration options.
```js
// src/app.ts
import { RuntimeConfig } from '@umijs/max'

export const locale: RuntimeConfig['locale'] = {
  textComponent: 'span',
  onError: () => {
    console.log('error handler...');
  }
  // ... other react-intl options
};
```
## FAQ

### Why not use the `formatMessage` shorthand directly?

While using the `formatMessage` shorthand is convenient, it operates outside of the React lifecycle. The most significant issue is that it can't trigger DOM re-rendering when switching languages. To address this issue, you would need to refresh the browser when switching languages, which results in poor user experience. Therefore, it's recommended to use `useIntl` or `injectIntl` to achieve the same functionality.
